# Copyright 2024 The ModelarDB Contributors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

x-aws-variables: &aws-variables
  AWS_ACCESS_KEY_ID: minioadmin
  AWS_SECRET_ACCESS_KEY: minioadmin
  AWS_DEFAULT_REGION: eu-central-1
  AWS_ENDPOINT: http://minio-server:9000
  AWS_ALLOW_HTTP: true

services:
  # Object store services.
  minio-server:
    image: minio/minio
    container_name: minio-server
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server --console-address ":9001" /data

  create-bucket:
    image: minio/mc
    container_name: create-bucket
    depends_on:
      - minio-server
    entrypoint:
      /bin/sh -c "
      sleep 2;
      /usr/bin/mc alias set modelardb-minio http://minio-server:9000 minioadmin minioadmin;
      /usr/bin/mc mb modelardb-minio/modelardb;
      exit 0;
      "

  # ModelarDB services.
  modelardb-edge-1:
    build: .
    image: modelardb
    container_name: modelardb-edge-1
    command: [ "target/debug/modelardbd", "edge", "data/edge", "s3://modelardb" ]
    ports:
      - "9999:9999"
    environment:
      <<: *aws-variables
      MODELARDBD_IP_ADDRESS: modelardb-edge-1
      MODELARDBD_PORT: 9999
    depends_on:
      create-bucket:
        condition: service_completed_successfully
    healthcheck:
      test: [ "CMD", "echo", "ready" ]
      interval: 2s

  modelardb-edge-2:
    image: modelardb
    container_name: modelardb-edge-2
    command: [ "target/debug/modelardbd", "edge", "data/edge", "s3://modelardb" ]
    ports:
      - "9998:9998"
    environment:
      <<: *aws-variables
      MODELARDBD_PORT: 9998
      MODELARDBD_IP_ADDRESS: modelardb-edge-2
    depends_on:
      modelardb-edge-1:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "echo", "ready" ]
      interval: 2s

  modelardb-cloud-1:
    image: modelardb
    container_name: modelardb-cloud-1
    command: [ "target/debug/modelardbd", "cloud", "data/cloud", "s3://modelardb" ]
    ports:
      - "9997:9997"
    environment:
      <<: *aws-variables
      MODELARDBD_PORT: 9997
      MODELARDBD_IP_ADDRESS: modelardb-cloud-1
    depends_on:
      modelardb-edge-2:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "echo", "ready" ]
      interval: 2s

  modelardb-cloud-2:
    image: modelardb
    container_name: modelardb-cloud-2
    command: [ "target/debug/modelardbd", "cloud", "data/cloud", "s3://modelardb" ]
    ports:
      - "9996:9996"
    environment:
      <<: *aws-variables
      MODELARDBD_PORT: 9996
      MODELARDBD_IP_ADDRESS: modelardb-cloud-2
    depends_on:
      modelardb-cloud-1:
        condition: service_healthy
